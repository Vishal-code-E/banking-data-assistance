# Backend API Reference
## Banking Data Assistant - Complete API Documentation

---

## üì° API BASE URL
```
http://localhost:8000
```

---

## üîå API ENDPOINTS

### 1. POST /query - Execute SQL Query (PRIMARY ENDPOINT)

**Description:** Execute a validated SQL SELECT query and get structured results.

**Request:**
```json
POST http://localhost:8000/query
Content-Type: application/json

{
  "sql": "SELECT * FROM customers LIMIT 10"
}
```

**Response Structure (Always Same Contract):**
```json
{
  "validated_sql": "string | null",
  "execution_result": {
    "data": [...],
    "row_count": 0,
    "execution_time_ms": 0.0
  } | null,
  "summary": "string | null",
  "chart_suggestion": "string | null",
  "error": "string | null"
}
```

**Success Response Example:**
```json
{
  "validated_sql": "SELECT * FROM customers LIMIT 10",
  "execution_result": {
    "data": [
      {
        "id": 1,
        "name": "John Doe",
        "email": "john.doe@email.com",
        "created_at": "2024-01-01T10:00:00"
      },
      {
        "id": 2,
        "name": "Jane Smith",
        "email": "jane.smith@email.com",
        "created_at": "2024-01-02T11:30:00"
      }
    ],
    "row_count": 2,
    "execution_time_ms": 15.32
  },
  "summary": "Query returned 2 row(s)",
  "chart_suggestion": "table",
  "error": null
}
```

**Error Response Example:**
```json
{
  "validated_sql": null,
  "execution_result": null,
  "summary": null,
  "chart_suggestion": null,
  "error": "Validation error: Only SELECT statements are allowed"
}
```

---

### 2. GET /health - Health Check

**Description:** Check API and database health status.

**Request:**
```
GET http://localhost:8000/health
```

**Response:**
```json
{
  "status": "healthy",
  "database": "sqlite",
  "tables": ["customers", "accounts", "transactions"],
  "error": null
}
```

**Error Response:**
```json
{
  "status": "unhealthy",
  "database": null,
  "tables": [],
  "error": "Database connection failed"
}
```

---

### 3. GET /info - API Information

**Description:** Get API metadata and capabilities.

**Request:**
```
GET http://localhost:8000/info
```

**Response:**
```json
{
  "app_name": "Banking Data Assistant",
  "version": "1.0.0",
  "allowed_tables": ["customers", "accounts", "transactions"],
  "features": [
    "Read-only SQL queries (SELECT only)",
    "Strict SQL validation",
    "SQL injection protection",
    "Table access whitelist",
    "Query result serialization",
    "Automatic type conversion"
  ]
}
```

---

### 4. GET /tables - List Available Tables

**Description:** Get detailed information about all queryable tables.

**Request:**
```
GET http://localhost:8000/tables
```

**Response:**
```json
{
  "tables": [
    {
      "name": "customers",
      "description": "Customer information including name and email",
      "columns": ["id", "name", "email", "created_at"]
    },
    {
      "name": "accounts",
      "description": "Bank accounts associated with customers",
      "columns": ["id", "customer_id", "account_number", "balance", "created_at"]
    },
    {
      "name": "transactions",
      "description": "All banking transactions (credits and debits)",
      "columns": ["id", "account_id", "type", "amount", "created_at"]
    }
  ],
  "count": 3
}
```

---

### 5. GET / - Root Endpoint

**Description:** API welcome message with quick links.

**Request:**
```
GET http://localhost:8000/
```

**Response:**
```json
{
  "message": "Banking Data Assistant API",
  "version": "1.0.0",
  "docs": "/docs",
  "health": "/health"
}
```

---

### 6. GET /docs - Swagger UI (Development)

**Description:** Interactive API documentation (auto-generated by FastAPI).

**URL:**
```
http://localhost:8000/docs
```

---

### 7. GET /redoc - ReDoc (Development)

**Description:** Alternative API documentation view.

**URL:**
```
http://localhost:8000/redoc
```

---

## üóÑÔ∏è DATABASE SCHEMA

### Table: `customers`
```sql
CREATE TABLE customers (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    email TEXT NOT NULL UNIQUE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

**Columns:**
- `id` - Integer, Primary Key, Auto-increment
- `name` - Text, Customer full name
- `email` - Text, Unique email address
- `created_at` - DateTime, Timestamp of record creation

---

### Table: `accounts`
```sql
CREATE TABLE accounts (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    customer_id INTEGER NOT NULL,
    account_number TEXT NOT NULL UNIQUE,
    balance DECIMAL(15, 2) NOT NULL DEFAULT 0.00,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (customer_id) REFERENCES customers(id)
);
```

**Columns:**
- `id` - Integer, Primary Key, Auto-increment
- `customer_id` - Integer, Foreign Key to customers.id
- `account_number` - Text, Unique account identifier
- `balance` - Decimal(15,2), Account balance in dollars
- `created_at` - DateTime, Timestamp of record creation

**Relationships:**
- Many accounts ‚Üí One customer

---

### Table: `transactions`
```sql
CREATE TABLE transactions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    account_id INTEGER NOT NULL,
    type TEXT NOT NULL CHECK(type IN ('credit', 'debit')),
    amount DECIMAL(15, 2) NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (account_id) REFERENCES accounts(id)
);
```

**Columns:**
- `id` - Integer, Primary Key, Auto-increment
- `account_id` - Integer, Foreign Key to accounts.id
- `type` - Text, Either 'credit' or 'debit'
- `amount` - Decimal(15,2), Transaction amount in dollars
- `created_at` - DateTime, Timestamp of transaction

**Relationships:**
- Many transactions ‚Üí One account

---

## üîí SQL VALIDATION RULES

### ‚úÖ ALLOWED
- `SELECT` statements only
- Queries on tables: `customers`, `accounts`, `transactions`
- Standard SQL clauses: WHERE, JOIN, GROUP BY, HAVING, ORDER BY, LIMIT
- Aggregate functions: COUNT, SUM, AVG, MIN, MAX
- Query length up to 5000 characters

### ‚ùå BLOCKED
- Data modification: INSERT, UPDATE, DELETE, DROP, CREATE, ALTER, TRUNCATE
- Multiple statements (semicolon-separated queries)
- SQL comments: `--` or `/* */`
- Dangerous keywords: EXEC, EXECUTE, PRAGMA, GRANT, REVOKE
- SQL injection patterns
- Unauthorized table access
- Queries longer than 5000 characters

---

## ‚ö†Ô∏è QUERY LIMITS & CONSTRAINTS

| Limit | Value | Description |
|-------|-------|-------------|
| **Max Query Length** | 5000 chars | Prevents DOS attacks |
| **Max Result Rows** | 1000 rows | Results truncated after this limit |
| **Query Timeout** | 30 seconds | Query automatically terminated |
| **Allowed Tables** | 3 tables | customers, accounts, transactions |

---

## üìä CHART SUGGESTIONS

Backend automatically suggests visualization types based on query results:

| Result Shape | row_count | columns | Suggestion |
|-------------|-----------|---------|------------|
| Empty | 0 | any | `"none"` |
| Single value | 1 | any | `"card"` |
| Label + Value | 2-5 | 2 | `"pie"` |
| Label + Value | 6+ | 2 | `"bar"` |
| Everything else | any | any | `"table"` |

---

## üîÑ DATA TYPE SERIALIZATION

Backend automatically serializes database types to JSON-compatible formats:

| Database Type | Serialized As | Example |
|--------------|---------------|---------|
| `datetime` | ISO 8601 string | `"2024-01-01T10:30:00"` |
| `date` | ISO date string | `"2024-01-01"` |
| `Decimal` | Float number | `1234.56` |
| `bytes` | UTF-8 string | `"binary data"` |
| `NULL` | null | `null` |
| `Integer` | Number | `42` |
| `String` | String | `"text"` |

---

## üö® ERROR HANDLING

### Error Response Contract
**All error responses follow the same structure as success responses:**

```json
{
  "validated_sql": null,
  "execution_result": null,
  "summary": null,
  "chart_suggestion": null,
  "error": "Error message here"
}
```

### Common Error Types

#### 1. Validation Errors
```json
{
  "error": "Validation error: Only SELECT statements are allowed"
}
```

**Causes:**
- Non-SELECT query (INSERT, UPDATE, DELETE, etc.)
- SQL comments in query
- Multiple statements
- Dangerous keywords
- Unauthorized table access

#### 2. Execution Errors
```json
{
  "error": "Query execution error: no such column: invalid_column"
}
```

**Causes:**
- Invalid SQL syntax
- Non-existent columns
- Invalid JOIN conditions

#### 3. Request Validation Errors
```json
{
  "error": "Request validation error: SQL query cannot be empty"
}
```

**Causes:**
- Empty or missing `sql` field
- Invalid JSON payload

#### 4. Server Errors
```json
{
  "error": "An internal server error occurred"
}
```

**Causes:**
- Database connection failure
- Unexpected server issues

---

## ‚öôÔ∏è CONFIGURATION

### Environment Variables

```bash
# Application
APP_NAME="Banking Data Assistant"
APP_VERSION="1.0.0"
DEBUG=False

# Database
DATABASE_URL="sqlite:///banking.db"
DB_POOL_SIZE=5
DB_MAX_OVERFLOW=10
DB_POOL_TIMEOUT=30

# Query Settings
QUERY_TIMEOUT=30
MAX_RESULT_ROWS=1000

# CORS
CORS_ORIGINS="http://localhost:3000,http://localhost:8080"
```

### Default Server Settings
- **Host:** `0.0.0.0`
- **Port:** `8000`
- **Reload:** Enabled in DEBUG mode
- **CORS:** Enabled for localhost:3000 and localhost:8080

---

## üåê CORS Configuration

**Allowed Origins:**
- `http://localhost:3000` (React default)
- `http://localhost:8080` (Alternative dev server)

**Allowed Methods:**
- `GET`
- `POST`

**Allowed Headers:**
- All (`*`)

**Credentials:**
- Allowed

---

## üí° EXAMPLE QUERIES

### Get All Customers
```sql
SELECT * FROM customers;
```

### Get Customer by ID
```sql
SELECT * FROM customers WHERE id = 1;
```

### Get Customer with Accounts
```sql
SELECT c.name, c.email, a.account_number, a.balance
FROM customers c
JOIN accounts a ON c.id = a.customer_id
WHERE c.id = 1;
```

### Get Total Balance by Customer
```sql
SELECT c.name, SUM(a.balance) as total_balance
FROM customers c
JOIN accounts a ON c.id = a.customer_id
GROUP BY c.id, c.name
ORDER BY total_balance DESC;
```

### Get Transaction Summary
```sql
SELECT 
    t.type,
    COUNT(*) as transaction_count,
    SUM(t.amount) as total_amount
FROM transactions t
GROUP BY t.type;
```

### Get Recent Transactions with Account Info
```sql
SELECT 
    a.account_number,
    t.type,
    t.amount,
    t.created_at
FROM transactions t
JOIN accounts a ON t.account_id = a.id
ORDER BY t.created_at DESC
LIMIT 10;
```

### Get Customer Account Summary
```sql
SELECT 
    c.name as customer_name,
    COUNT(a.id) as account_count,
    SUM(a.balance) as total_balance,
    COUNT(t.id) as transaction_count
FROM customers c
LEFT JOIN accounts a ON c.id = a.customer_id
LEFT JOIN transactions t ON a.id = t.account_id
GROUP BY c.id, c.name
ORDER BY total_balance DESC;
```

---

## üîß FRONTEND INTEGRATION GUIDE

### JavaScript/TypeScript Example

```javascript
// API Service
class BankingAPI {
  constructor(baseURL = 'http://localhost:8000') {
    this.baseURL = baseURL;
  }

  async executeQuery(sql) {
    const response = await fetch(`${this.baseURL}/query`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ sql }),
    });
    
    return await response.json();
  }

  async getHealth() {
    const response = await fetch(`${this.baseURL}/health`);
    return await response.json();
  }

  async getTables() {
    const response = await fetch(`${this.baseURL}/tables`);
    return await response.json();
  }

  async getInfo() {
    const response = await fetch(`${this.baseURL}/info`);
    return await response.json();
  }
}

// Usage
const api = new BankingAPI();

// Execute query
const result = await api.executeQuery('SELECT * FROM customers LIMIT 10');

if (result.error) {
  console.error('Query failed:', result.error);
} else {
  console.log('Query succeeded!');
  console.log('Data:', result.execution_result.data);
  console.log('Rows:', result.execution_result.row_count);
  console.log('Time:', result.execution_result.execution_time_ms, 'ms');
  console.log('Suggestion:', result.chart_suggestion);
}
```

### React Hook Example

```javascript
import { useState } from 'react';

function useQuery() {
  const [loading, setLoading] = useState(false);
  const [result, setResult] = useState(null);
  const [error, setError] = useState(null);

  const executeQuery = async (sql) => {
    setLoading(true);
    setError(null);
    
    try {
      const response = await fetch('http://localhost:8000/query', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sql }),
      });
      
      const data = await response.json();
      
      if (data.error) {
        setError(data.error);
        setResult(null);
      } else {
        setResult(data);
        setError(null);
      }
    } catch (err) {
      setError('Network error: ' + err.message);
      setResult(null);
    } finally {
      setLoading(false);
    }
  };

  return { executeQuery, loading, result, error };
}
```

---

## ‚úÖ FRONTEND CHECKLIST

### Must-Have Features
- [ ] POST requests to `/query` endpoint
- [ ] Handle both success and error responses
- [ ] Display `execution_result.data` in table format
- [ ] Show error messages prominently
- [ ] Display query metadata (row count, execution time)
- [ ] Input validation before sending

### Nice-to-Have Features
- [ ] Chart visualization based on `chart_suggestion`
- [ ] Query builder UI for common queries
- [ ] Table/column autocomplete
- [ ] Query history
- [ ] Export results (CSV, JSON)
- [ ] Syntax highlighting for SQL
- [ ] Loading states and animations
- [ ] Real-time query validation

### Visualization Mapping
```javascript
const chartMap = {
  'none': () => <EmptyState />,
  'card': (data) => <MetricCard value={data[0]} />,
  'table': (data) => <DataTable rows={data} />,
  'bar': (data) => <BarChart data={data} />,
  'pie': (data) => <PieChart data={data} />,
};

// Render based on suggestion
const Chart = chartMap[result.chart_suggestion];
return <Chart data={result.execution_result.data} />;
```

---

## üöÄ QUICK START

### 1. Start Backend Server
```bash
cd backend
python -m uvicorn main:app --reload --port 8000
```

### 2. Test API
```bash
# Health check
curl http://localhost:8000/health

# Execute query
curl -X POST http://localhost:8000/query \
  -H "Content-Type: application/json" \
  -d '{"sql": "SELECT * FROM customers LIMIT 5"}'
```

### 3. Build Frontend
Use this API reference to build your frontend that connects to the backend.

---

## üìö ADDITIONAL RESOURCES

- **Swagger UI:** http://localhost:8000/docs
- **ReDoc:** http://localhost:8000/redoc
- **Source Code:** `backend/` directory
- **Database Schema:** `models/schema.sql`
- **Tests:** `tests/` directory

---

## üîê SECURITY NOTES

1. **Read-Only Access:** Backend enforces read-only queries
2. **SQL Injection Protection:** Multiple validation layers
3. **Table Whitelist:** Only 3 tables accessible
4. **No Comments:** SQL comments blocked to prevent injection
5. **Query Limits:** Prevents DOS attacks
6. **CORS:** Restricted to localhost origins only

---

## üìù NOTES FOR FRONTEND DEVELOPERS

1. **Always check `error` field first** in response
2. **Data is always in consistent format** (same contract for success/error)
3. **Datetime values are ISO strings** - parse accordingly
4. **Results may be truncated** at 1000 rows
5. **Chart suggestion is a hint** - you can ignore it
6. **CORS is configured** for localhost:3000 and :8080
7. **No authentication required** (for development)

---

**Last Updated:** February 21, 2026  
**API Version:** 1.0.0  
**Backend Framework:** FastAPI  
**Database:** SQLite

---

